<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('https://wallpaperbat.com/img/70780327-skyline-5120x2880.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #000000; 
            min-height: 100vh;
        }

        header {
            background-color: #007BFF;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        header h1 {
            font-size: 1.5rem;
            margin-bottom: 0;
        }

        .logout-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: #fff;
            color: #007BFF;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        main {
            padding: 2rem;
            max-width: 1200px;
            margin: auto;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .filters select,
        .filters input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .filters button {
            padding: 0.6rem;
            background-color: #00bcd4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .car-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .car-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .car-card:hover {
            transform: translateY(-5px);
        }

        .car-image {
            width: 100%;
            height: 180px;
            background: #ddd;
            background-size: cover;
            background-position: center;
        }

        .car-info {
            padding: 1rem;
        }

        .car-info h3 {
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .car-info p {
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
        }

        .car-info strong {
            color: #007BFF;
        }

        footer {
            background-color: #007BFF;
            color: white;
            text-align: center;
            padding: 1rem;
        }
    </style>
</head>
<body>

<header>
    <h1>CarDB ‚Äî –ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</h1>
    <div>
        <a href="/index.html" class="logout-btn">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="/profile.html" class="logout-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
    </div>
</header>

<main>
    <section class="filters">
        <!-- –ë—Ä–µ–Ω–¥ –∏ –º–æ–¥–µ–ª—å -->
        <select id="brandFilter">
            <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
        </select>

        <select id="modelFilter" disabled>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>
        </select>

        <!-- –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ -->
        <select id="bodyTypeFilter">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫—É–∑–æ–≤–∞</option>
        </select>

        <select id="driveTypeFilter">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥</option>
        </select>

        <select id="engineFilter">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å</option>
        </select>

        <select id="transmissionFilter">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ—Ä–æ–±–∫–∏ –ø–µ—Ä–µ–¥–∞—á</option>
        </select>

        <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <input type="number" id="yearFilter" placeholder="–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞">
        <input type="number" id="minPrice" placeholder="–ú–∏–Ω. —Ü–µ–Ω–∞">
        <input type="number" id="maxPrice" placeholder="–ú–∞–∫—Å. —Ü–µ–Ω–∞">
        <input type="number" id="powerFilter" placeholder="–ú–æ—â–Ω–æ—Å—Ç—å">
        <input type="text" id="steerWheelFilter" placeholder="–†—É–ª—å (–ª–µ–≤—ã–π/–ø—Ä–∞–≤—ã–π)">
        
        <select id="sort">
            <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</option>
            <option value="price_asc">–¶–µ–Ω–∞ ‚Üë</option>
            <option value="price_desc">–¶–µ–Ω–∞ ‚Üì</option>
            <option value="year_asc">–ì–æ–¥ ‚Üë</option>
            <option value="year_desc">–ì–æ–¥ ‚Üì</option>
            <option value="power_asc">–ú–æ—â–Ω–æ—Å—Ç—å ‚Üë</option>
            <option value="power_desc">–ú–æ—â–Ω–æ—Å—Ç—å ‚Üì</option>
        </select>

        <button onclick="loadCars()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <div id="adminActions" style="display: none;">
            <a href="/add-car.html" class="logout-btn" style="background-color: #00bcd4; color: white;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ</a>
        </div>
    </section>

    <div class="car-grid" id="carsList"></div>
</main>

<footer>
    <p>&copy; 2025 CarDB | –£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –ù–ò–£ –í–®–≠ –ú–ò–≠–ú</p>
</footer>

<script>
    window.onload = () => {
        checkUserRole().then(loadCars);
        loadBrandsAndModels();
        loadFilterOptions();
        

        document.getElementById('brandFilter').addEventListener('change', function () {
            const selectedBrand = this.value;
            updateModelOptions(selectedBrand);
        });

        const user = JSON.parse(localStorage.getItem('user'));
        const adminActions = document.getElementById('adminActions');
        if (user && user.role === 'admin') {
            adminActions.style.display = 'block';
        }
    };

    let carsData = [];
    let allModels = [];

    async function checkUserRole() {
        const res = await fetch("/api/users/me", {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        });

        if (!res.ok) {
            localStorage.removeItem("token");
            window.location.href = "/login.html";
            return;
        }

        const user = await res.json();
        localStorage.setItem("user", JSON.stringify(user));
    }

    async function getCarImageURL(carID) {
        try {
            const res = await fetch(`/api/cars/${carID}/images`, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });

            if (!res.ok) return null;

            const urls = await res.json();
            return urls.length > 0 ? urls[0] : null;
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:", err);
            return null;
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –º–æ–¥–µ–ª–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤ –∏ –º–æ–¥–µ–ª–µ–π
    async function loadBrandsAndModels() {
        const res = await fetch('/api/models', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });

        if (!res.ok) return alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª–∏");

        const models = await res.json();
        allModels = models;

        const brandSelect = document.getElementById('brandFilter');
        const brandsSet = new Set();

        models.forEach(model => {
            brandsSet.add(model.brand);
        });

        brandSelect.innerHTML = '<option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>';
        brandsSet.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand.toLowerCase();
            option.textContent = brand;
            brandSelect.appendChild(option);
        });
    }

    // –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –±—Ä–µ–Ω–¥—É
    function updateModelOptions(selectedBrand) {
        const modelSelect = document.getElementById('modelFilter');
        modelSelect.disabled = !selectedBrand;
        modelSelect.innerHTML = '<option value="">–í—Å–µ –º–æ–¥–µ–ª–∏</option>';

        if (!selectedBrand) return;

        const filteredModels = allModels.filter(model =>
            model.brand.toLowerCase() === selectedBrand
        );

        filteredModels.forEach(model => {
            const option = document.createElement('option');
            option.value = model.model_id;
            option.textContent = model.name;
            modelSelect.appendChild(option);
        });
    }

    let allBodyTypes = [];
    let allDriveTypes = [];
    let allEngines = [];
    let allTransmissions = [];

    async function loadFilterOptions() {
        const token = localStorage.getItem('token');
        const base = '/api/';

        async function fetchList(endpoint) {
            const res = await fetch(base + endpoint, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) return [];
            return await res.json();
        }

        allBodyTypes = await fetchList('bodytypes');
        allDriveTypes = await fetchList('drivetypes');
        allEngines = await fetchList('engines');
        allTransmissions = await fetchList('transmissions');

        populateSelect('bodyTypeFilter', allBodyTypes, 'name');
        populateSelect('driveTypeFilter', allDriveTypes, 'name');
        populateSelect('engineFilter', allEngines, 'name');
        populateSelect('transmissionFilter', allTransmissions, 'name');
    }

    function populateSelect(id, list, labelField) {
        const select = document.getElementById(id);
        //select.innerHTML = '<option value="">–í—Å–µ</option>';
        list.forEach(item => {
            const option = document.createElement('option');
            option.value = item[labelField];
            option.textContent = item[labelField];
            select.appendChild(option);
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
    async function loadCars() {
        const params = new URLSearchParams();

        const brand = document.getElementById('brandFilter').value.trim().toLowerCase();
        const model = document.getElementById('modelFilter').value.trim();
        const bodyType = document.getElementById('bodyTypeFilter').value.trim().toLowerCase();
        const driveType = document.getElementById('driveTypeFilter').value.trim().toLowerCase();
        const engine = document.getElementById('engineFilter').value.trim().toLowerCase();
        const transmission = document.getElementById('transmissionFilter').value.trim().toLowerCase();
        const year = document.getElementById('yearFilter').value.trim();
        const minPrice = document.getElementById('minPrice').value.trim();
        const maxPrice = document.getElementById('maxPrice').value.trim();
        const power = document.getElementById('powerFilter').value.trim();
        const steerWheel = document.getElementById('steerWheelFilter').value.trim().toLowerCase();
        const sort = document.getElementById('sort').value;

        if (brand) params.append('brand', brand);
        if (model) params.append('model', model);
        if (bodyType) params.append('body_type', bodyType);
        if (driveType) params.append('drive_type', driveType);
        if (engine) params.append('engine', engine);
        if (transmission) params.append('transmission', transmission);
        if (year) params.append('year', year);
        if (minPrice) params.append('min_price', minPrice);
        if (maxPrice) params.append('max_price', maxPrice);
        if (power) params.append('power', power);
        if (steerWheel) params.append('steer_wheel', steerWheel);
        if (sort) params.append('sort', sort);

        const res = await fetch(`/api/cars?${params}`, {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });

        if (!res.ok) return alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ");

        carsData = await res.json();
        renderCars();
    }

    async function renderCars() {
        const container = document.getElementById('carsList');
        container.innerHTML = '';

        if (carsData.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    –ê–≤—Ç–æ–º–æ–±–∏–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                </div>
            `;
        }

        const userRole = JSON.parse(localStorage.getItem('user'))?.role || 'user';

        for (const car of carsData) {
            const model = allModels.find(m => m.model_id === car.model) || { name: "–ú–æ–¥–µ–ª—å", brand: "–ë—Ä–µ–Ω–¥" };
            const imageURL = car.image_url || 'https://belkacheli.com/upload/iblock/6f7/lye2yb7y1xr2b8z0cidwt9h7gsxviidp.png';

            // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –∏–∑ API –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
            const finalImageURL = await getCarImageURL(car.id) || imageURL;

            const card = document.createElement('div');
            card.className = 'car-card';
            card.innerHTML = `
                <div class="car-image" style="background-image: url('${finalImageURL}')"></div>
                <div class="car-info">
                    <h3>${model.brand} ${model.name}</h3>
                    <p><strong>–ì–æ–¥:</strong> ${car.year}</p>
                    <p><strong>–¶–µ–Ω–∞:</strong> ${car.price.toLocaleString()} ‚ÇΩ</p>
                    <p><strong>–¶–≤–µ—Ç:</strong> ${car.color}</p>
                    <p><strong>–î–≤–∏–≥–∞—Ç–µ–ª—å:</strong> ${car.engine}</p>
                    <p><strong>–ö—É–∑–æ–≤:</strong> ${car.body_type}</p>
                </div>
            `;

            card.addEventListener('click', () => {
                window.location.href = `/car.html?id=${car.id}`;
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
            if (userRole === 'admin') {
                const editBtn = document.createElement('button');
                editBtn.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                editBtn.style.marginRight = '10px';
                editBtn.onclick = () => window.location.href = `/edit-car.html?id=${car.id}`;
                editBtn.style.background = '#00bcd4'; 
                editBtn.style.color = 'white';
                editBtn.style.border = 'none';
                editBtn.style.padding = '10px 20px';
                editBtn.style.borderRadius = '5px';
                editBtn.style.cursor = 'pointer';

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                deleteBtn.style.background = '#e50914';
                deleteBtn.style.color = 'white';
                deleteBtn.style.border = 'none';
                deleteBtn.style.padding = '10px 20px';
                deleteBtn.style.borderRadius = '5px';
                deleteBtn.style.cursor = 'pointer';

                deleteBtn.onclick = async () => {
                    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å?")) return;

                    const res = await fetch(`/api/cars/${car.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        }
                    });

                    if (!res.ok) {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å");
                        return;
                    }

                    alert("–ê–≤—Ç–æ–º–æ–±–∏–ª—å —É–¥–∞–ª–µ–Ω");
                    loadCars();
                };

                const btnContainer = document.createElement('div');
                btnContainer.style.textAlign = 'center';
                btnContainer.style.marginTop = '6px';
                btnContainer.appendChild(editBtn);
                btnContainer.appendChild(deleteBtn);

                card.appendChild(btnContainer);
            }

            container.appendChild(card);
        }
    }
</script>

</body>
</html>